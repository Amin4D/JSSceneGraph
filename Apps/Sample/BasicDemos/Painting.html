<html xmlns="http://www.w3.org/1999/xhtml"> 
  <!--
    Copyright 2010-2011 Fabric Technologies Inc. All rights reserved.
    -->
  <head> 
    <title>FABRIC - Painting</title> 
    
    <meta charset="iso-8859-1"/>
    <link href="../../../themes/default/style.css" rel="stylesheet" type="text/css" />
    <link href="../../../themes/default/viewer.css" rel="stylesheet" type="text/css" />
    
    <script type="text/javascript" src="../../../ThirdParty/jQuery/jquery-1.4.2.min.js"></script>
    <script type="text/javascript" src="../../../ThirdParty/jQuery/jquery-ui-1.8.5.custom.min.js"></script>

    <link type="text/css" href="../../../ThirdParty/jQuery/css/vader/jquery-ui-1.8.5.custom.css" rel="stylesheet" />
    <script type="text/javascript" src="../../../ThirdParty/jQuery/colorpicker/js/colorpicker.js"></script>
    <link href="../../../ThirdParty/jQuery/colorpicker/css/colorpicker.css" rel="stylesheet" type="text/css" />

      <script type="text/javascript" src="../../../Core/FABRIC.Wrappers.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../Core/FABRIC.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/RT/Math.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/RT/RGBA.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/RT/Vec2.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/RT/Vec3.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/RT/Vec4.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/RT/Mat22.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/RT/Mat33.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/RT/Mat44.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/RT/Quat.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/RT/Xfo.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/RT/Color.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/RT/Ray.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/RT/CollectedPoints.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/RT/RGBA.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/RT/Euler.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/RT/OGLShaderProgram.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/RT/OGLBuffer.js" charset="utf-8"></script>
    

    <script type="text/javascript" src="../../../SceneGraph/FABRIC.SceneGraph.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/FABRIC.SceneGraph.Geometry.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/FABRIC.SceneGraph.Primitives.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/FABRIC.SceneGraph.Lights.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/FABRIC.SceneGraph.Materials.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/FABRIC.SceneGraph.Manipulation.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/FABRIC.SceneGraph.Particles.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/FABRIC.SceneGraph.Kinematics.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/Parsers/parseOBJ.js" charset="utf-8"></script>
    
    <style type="text/css">
    
#sidebar {
  width:400px;
}  
#viewer {
  right:400px;
}

  
  </style>
    
    <script type="text/javascript">
    
    
FABRIC.SceneGraph.registerNodeType('PaintVertexColorsManipulator', {
  factoryFn: function(options, scene) {
    scene.assignDefaults(options, {
      brushColor: FABRIC.RT.rgb(0.8, 0.0, 0.0)
      });
    
    options.paintingOpDef = {
          operatorName: 'paintVertexColors',
          srcFile: 'KL/paintOp.kl',
          entryFunctionName: 'paintVertexColors',
          parameterLayout: [
            'paintData.cameraMatrix',
            'paintData.projectionMatrix',
            'paintData.aspectRatio',

            'paintData.brushPos',
            'paintData.brushSize',
            'paintData.brushColor',

            'transform.globalXfo',
            'geometryattributes.positions<>',
            'geometryattributes.normals<>',
            'geometryattributes.vertexColors<>'
          ],
          async: false
        };
    
    var vertexColorsPaintManipulator = scene.constructNode('PaintManipulator', options);
    
    var paintEventHandler = vertexColorsPaintManipulator.getPaintEventHandler();
    paintEventHandler.addMember('brushColor', 'Color', options.brushColor);
    vertexColorsPaintManipulator.addMemberInterface(paintEventHandler, 'brushColor', true);
    
    return vertexColorsPaintManipulator;
  }});


$(document).ready(function() {
    $('#play').button({
      text: true,
      icons: {
        primary: 'ui-icon-play'
      }
    });

    $('#step').button({
      text: true,
      icons: {
        primary: 'ui-icon-step'
      }
    });

  var scene = FABRIC.SceneGraph.createScene();
  var viewport = scene.constructNode('Viewport', {
    windowElement: document.getElementById('FabricContainer'),
    backgroundColor: FABRIC.RT.rgb(0.3, 0.5, 0.7)
  });

  // Create a camera to draw the scene from
  camera = scene.constructNode('TargetCamera', {
      nearDistance: 0.01,
      farDistance: 5,
      position: FABRIC.RT.vec3(-0.03, 0.19, 0.21),
      target: FABRIC.RT.vec3(-0.03, 0.06, -0.03)
    });

  var cameraManipulator = scene.constructNode('CameraManipulator', { targetNode: camera });

  viewport.setCameraNode(camera);

  //constraint a pointLight to the camera
  var light = scene.constructNode('PointLight', { transformNode: camera.getTransformNode() });
  var material = scene.constructNode('PhongVertexColorMaterial', { lightNode: light });

  var assets = scene.importAssetFile('Models/bunny.obj');
  geometry = assets['bunny'];

  geometry.addVertexAttributeValue('vertexColors', 'Color', { defaultValue:FABRIC.RT.rgb(0.0, 0.6, 0.0), genVBO:true });

  var instanceNode = scene.constructNode('Instance', { geometryNode: geometry, materialNode: material });


  /////////////////////////////////////////////////
  // Set up the painting manipulator
  var brushSize = 0.1;
  var brushColor = FABRIC.RT.rgb(0.8, 0.0, 0.0);
  var paintManipulator = scene.constructNode('PaintVertexColorsManipulator', {
      brushSize: brushSize,
      enabled:false,
      brushColor: brushColor
    });
  paintManipulator.addPaintableNode(instanceNode);

  var onPaintFn = function(evt) {
    if( evt.paintData.points.length == 0 ){
      return;
    }
    geometry.reloadVBO('vertexColors');
  };
  paintManipulator.addEventListener('onpaint', onPaintFn);
  
  // Switch to painting when the 'P' key is pressed
  window.onkeydown = function(evt) {
      if(String.fromCharCode(evt.keyCode) == 'P'){
        cameraManipulator.disable();
        paintManipulator.enable();
      }
    };
  window.onkeyup = function(evt) {
      if(String.fromCharCode(evt.keyCode) == 'P'){
        cameraManipulator.enable();
        paintManipulator.disable();
      }
    };

  $('#brushColor').ColorPicker({
      flat: true,
      color: { r: brushColor.r * 255, g: brushColor.g * 255, b: brushColor.b * 255} ,
      onChange: function(hsb, hex, rgb) {
      //  paintManipulator.setBrushColor(FABRIC.RT.rgb255(rgb.r, rgb.g, rgb.b));
        paintManipulator.setBrushColor( FABRIC.RT.rgb255(rgb.r, rgb.g, rgb.b));
      }
    });

  $('#loadingDialog').dialog({
    modal: true
  });
  var count = FABRIC.getAsyncTaskCount();
  FABRIC.appendOnResolveAsyncTaskCallback(function(label, countRemaining){
    $('#loadingProgressBar').progressbar({
      value: (1.0-(countRemaining/count))*100
    });
    if(countRemaining===0){
      $('#loadingDialog').dialog('close');
      var errors = scene.getErrors();
      if (errors.length > 0) {
        throw (errors.toString());
      }
      viewport.redraw();
      return true;
    }
  });
  
});

</script>

  </head> 
  <body>
    <div id="loadingDialog" title="Loading...">
      <h4 id="loadingDesc" style="margin-bottom: 10px"></h4>
      <div id="loadingProgressBar" class="ui-progressbar-value"></div>
    </div>
    <div id="wrapper">
      <ul id="nav">
        <li><a href="#" id="fabric-logo"><img src="../../../themes/default/_img/projects/fabric-logo.png" /></a></li>
      </ul>
      <div id="editor">
        <div id="viewer">
          <div id="FabricContainer"></div> 
        </div><!--viewer-->
        <div id="sidebar" style="width=400px">
        
          <div class="box">
            <h2>INFO</h2>
            <div class="content">
              Vertex Map Painting.<br>
              The painting interface is built using event hanlders, and it very similar to ray casting.
              With ray casting, we return the intersection data back to JavaScript, whereas with painting,
              we return all points within range of the brush. Any data in the scene can be modified,
              and in this example, we simply modify the vertex colors.<br><br>
              Hold 'P' to go into paint mode.<br>
              Use the mouse wheel while in 'Paint' mode to resize the brush.
            </div><!--content-->
          </div><!--box-->

                <div class="box">
                    <h2>CONTROLS</h2>
                    <div class="content">
                 <p id="brushColor"></p>
                    </div><!--content-->
                </div><!--box-->
      
        </div><!--sidebar-->
      </div> <!--editor-->
    </div><!--wrapper-->
  </body> 
  </html>
