<html xmlns="http://www.w3.org/1999/xhtml"> 
  <!--
    Copyright 2010-2011 Fabric Technologies Inc. All rights reserved.
    -->
  <head> 
    <title>FABRIC - Selection</title> 
    
    <meta charset="iso-8859-1"/>
    <link href="../../../themes/default/style.css" rel="stylesheet" type="text/css" />
    <link href="../../../themes/default/viewer.css" rel="stylesheet" type="text/css" />
    
    <script type="text/javascript" src="../../../ThirdParty/jQuery/jquery-1.4.2.min.js"></script>
    <script type="text/javascript" src="../../../ThirdParty/jQuery/jquery-ui-1.8.5.custom.min.js"></script>

    <link type="text/css" href="../../../ThirdParty/jQuery/css/vader/jquery-ui-1.8.5.custom.css" rel="stylesheet" />

    <script type="text/javascript" src="../../../Core/FABRIC.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/RT/Math.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/RT/Vec2.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/RT/Vec3.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/RT/Vec4.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/RT/Mat22.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/RT/Mat33.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/RT/Mat44.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/RT/Quat.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/RT/Xfo.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/RT/RGBA.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/RT/Color.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/RT/Euler.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/RT/Ray.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/RT/CollectedPoints.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/RT/OGLShaderProgram.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/RT/OGLBuffer.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/RT/OGLTexture2D.js" charset="utf-8"></script>
    
    <script type="text/javascript" src="../../../SceneGraph/FABRIC.SceneGraph.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/FABRIC.SceneGraph.Geometry.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/FABRIC.SceneGraph.Primitives.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/FABRIC.SceneGraph.Kinematics.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/FABRIC.SceneGraph.Materials.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/FABRIC.SceneGraph.Lights.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/FABRIC.SceneGraph.Manipulation.js" charset="utf-8"></script>
    
    <script type="text/javascript" src="../../../SceneGraph/FABRIC.SceneGraph.Selection.js" charset="utf-8"></script>
    
<script type="text/javascript">

 var _gaq = _gaq || [];
 _gaq.push(['_setAccount', 'UA-25833362-1']);
 _gaq.push(['_trackPageview']);

 (function() {
   var ga = document.createElement('script'); ga.type =
'text/javascript'; ga.async = true;
   ga.src = ('https:' == document.location.protocol ? 'https://ssl' :
'http://www') + '.google-analytics.com/ga.js';
   var s = document.getElementsByTagName('script')[0];
s.parentNode.insertBefore(ga, s);
 })();

</script>

<style>
  #selectable .ui-selecting { background: #757a9f; }
  #selectable .ui-selected { background: #4e516a; color: white; }
  #selectable { list-style-type: none; margin: 0; padding: 0; }
  #selectable li { margin: 3px; padding: 0.4em; font-size: 1.0em; height: 10px; }
</style>


    <script type="text/javascript">
    
    
    
    
    
    
// These Node definitions are inlined for now, but will
// be moved to a separate file once they are stabilized. 
FABRIC.SceneGraph.registerNodeType('SelectableInstance', {
  factoryFn: function(options, scene) {
    scene.assignDefaults(options, {
      highlightMaterial: undefined,
      selectMaterial: undefined
    });
    
    var selectableInstance = scene.constructNode('Instance', options);
    
    var selectable = true;
    selectableInstance.pub.isSelectable = function(){
      return selectable;
    }
    selectableInstance.pub.setSelectable = function(val){
      selectable = val;
    }
    var highglighted = false;
    var selected = false;
    selectableInstance.pub.addEventListener('highlight', function(evt) {
      if(!selected){
        selectableInstance.pub.setMaterialNode( options.highlightMaterial );
        highglighted = true;
      }
    });
    selectableInstance.pub.addEventListener('unhighlight', function(evt) {
      if(highglighted){
        selectableInstance.pub.removeMaterialNode( options.highlightMaterial );
        highglighted = false;
      }
    });
    selectableInstance.pub.addEventListener('selected', function(evt) {
      if(highglighted){
        selectableInstance.pub.removeMaterialNode( options.highlightMaterial );
        highglighted = false;
      }
      selectableInstance.pub.setMaterialNode( options.selectMaterial );
      selected = true;
    });
    selectableInstance.pub.addEventListener('deselected', function(evt) {
      selectableInstance.pub.removeMaterialNode( options.selectMaterial );
      selected = false;
    });
    
    return selectableInstance;
  }});
    
    
$(document).ready(function() {
  
  var scene = FABRIC.SceneGraph.createScene();

  var camera = scene.constructNode('TargetCamera', {
      position: new FABRIC.RT.Vec3(20, 30, 30).multiplyScalar(1.5),
      target: new FABRIC.RT.Vec3(0, 2, 0)
    });
  var viewport = scene.constructNode('Viewport', {
      enableRaycasting: true,
      windowElement: document.getElementById('FabricContainer'),
      cameraNode: camera
    });
  
  viewport.setBackgroundTextureImage(scene.constructNode('Image', {
    url: 'Resources/fabric-demo-gradient.png'
  }));

  scene.constructNode('CameraManipulator', { targetNode: camera });
  
  
  
  var selectionManager = scene.constructManager('ViewportSelectionManager');
  var selectionManipulationManager = scene.constructManager('SelectionManipulationManager', {
    selectionManager: selectionManager
  });
  
  // create the scene grid
  scene.constructNode('Instance', {
    geometryNode: scene.constructNode('Grid', {
      size_x: 40.0,
      size_z: 40.0,
      sections_x: 20,
      sections_z: 20 }),
    materialNode: scene.constructNode('FlatMaterial')
  });
  

  var light = scene.constructNode('PointLight', { position: new FABRIC.RT.Vec3(420.0, 1000.0, 600.0) });
  var materials = [
      scene.constructNode('PhongMaterial', { diffuseColor: FABRIC.RT.rgb(0.8, 0, 0, 1), lightNode: light }),
      scene.constructNode('PhongMaterial', { diffuseColor: FABRIC.RT.rgb(0, 0.8, 0, 1), lightNode: light }),
      scene.constructNode('PhongMaterial', { diffuseColor: FABRIC.RT.rgb(0, 0, 0.8, 1), lightNode: light })
    ];
  
  var highlightMaterial = scene.constructNode('OutlineShader', {
    color: FABRIC.RT.rgb(0.6, 0.6, 0.6, 0.5),
    thickness: 0.2
  });
  var selectedMaterial = scene.constructNode('OutlineShader', {
    color: FABRIC.RT.rgb(0.9, 0.9, 0.9, 1),
    thickness: 0.2
  });
  
  var nodes = {};
  var objId = 0;
  var scale = 2.0;
  var gridSize = 25.0;
  for (var k = 1; k < 16; k++) {
    var radius = (Math.random() + 0.5) * scale;
    var tr = new FABRIC.RT.Vec3(
      (Math.random() - 0.5) * gridSize,
      radius,
      (Math.random() - 0.5) * gridSize
    );

    var xfo = FABRIC.RT.xfo({ tr:tr });
    var transformNode = scene.constructNode('Transform', { hierarchical: false, globalXfo: xfo });

    var sphere = scene.constructNode('Sphere', {
      name: 'SphereMesh',
      radius: radius,
      detail: 10
    });
    var inst = scene.constructNode('SelectableInstance', {
        name: 'SphereInstance',
        transformNode: transformNode,
        geometryNode: sphere,
        materialNode: materials[objId % materials.length],
        enableRaycasting: true,
        
        highlightMaterial: highlightMaterial,
        selectMaterial: selectedMaterial
      });
    nodes[inst.getName()] = inst;
    objId++;
  }
  
  var selecting = false;
  for(var i in nodes){
    $("#selectable").append('<li class="ui-widget-content" id="'+i+'">'+i+'</li>');
  }
  $( "#selectable" ).selectable({
    selected: function(event, ui) {
      var selection = [];
      var selectedChildren = $("#selectable").children('.ui-selected');
      for(var i=0; i<selectedChildren.length; i++){
        selection.push(nodes[$(selectedChildren[i]).attr('id')]);
      }
      selecting = true;
      selectionManager.select(selection);
      scene.redrawAllViewports();
      selecting = false;
    }
  });
  
  selectionManager.addEventListener('selectionChanged', function(evt){
    if(selecting) return;
    $("#selectable").children().each(function(){
      $(this).removeClass('ui-selected');
    });
    for(var i=0; i<evt.selection.length; i++){
      $("#"+evt.selection[i].getName()).addClass('ui-selected');
    }
  });
  

  $('#loadingDialog').dialog({
    modal: true
  });
  var count = FABRIC.getActiveAsyncTaskCount();
  FABRIC.appendOnResolveAsyncTaskCallback(function(label, nbRemaining, doneWeight, totalWeight){
    $('#loadingProgressBar').progressbar({
      value: (1.0-(doneWeight/totalWeight))*100
    });
    if(nbRemaining===0){
      $('#loadingDialog').dialog('close');
      var errors = scene.getErrors();
      if (errors.length > 0) {
        throw (errors.toString());
      }
      viewport.redraw();
      return true;
    }
  });
  
});

</script>

  </head> 
  <body>
    <div id="loadingDialog" title="Loading...">
      <h4 id="loadingDesc" style="margin-bottom: 10px"></h4>
      <div id="loadingProgressBar" class="ui-progressbar-value"></div>
    </div>
    <div id="wrapper">
      <ul id="nav">
        <li><a href="#" id="fabric-logo"><img src="../../../themes/default/_img/projects/fabric-logo.png" /></a></li>
      </ul>
      <div id="editor">
        <div id="viewer">
          <div id="FabricContainer"></div> 
        </div><!--viewer-->
        <div id="sidebar">
          
          <div class="box">
            <h2>INFO</h2>
            <div class="content">
              Mouse Events.<br>
              This sample shows the use of mouse events in FABRIC. As the mouse is moved
              over the viewport, rays are cast into the scene. Hit objects are collected,
              and JavaScript event handlers are invoked. Have a look at the source code of
              this page to learn how this works.
            </div><!--content-->
          </div><!--box-->

          <div class="box">
            <h2>SELECTION</h2>
            <div class="content">
              <ol id="selectable">
              </ol>
            </div>
          </div><!--box-->
            
        </div><!--sidebar-->
      </div> <!--editor-->
    </div><!--wrapper-->
  </body> 
  </html>
