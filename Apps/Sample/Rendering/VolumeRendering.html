<html xmlns="http://www.w3.org/1999/xhtml"> 
  <!--
    Copyright 2010-2011 Fabric Technologies Inc. All rights reserved.
    -->
  <head> 
    <title>FABRIC - Volume Rendering</title> 
    
    <meta charset="iso-8859-1"/>
    <link href="../../../themes/default/style.css" rel="stylesheet" type="text/css" />
    <link href="../../../themes/default/viewer.css" rel="stylesheet" type="text/css" />
    
    <script type="text/javascript" src="../../../ThirdParty/jQuery/jquery-1.4.2.min.js"></script>
    <script type="text/javascript" src="../../../ThirdParty/jQuery/jquery-ui-1.8.5.custom.min.js"></script>

    <link type="text/css" href="../../../ThirdParty/jQuery/css/vader/jquery-ui-1.8.5.custom.css" rel="stylesheet" />

    <script type="text/javascript" src="../../../Core/FABRIC.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/RT/Math.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/RT/Vec2.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/RT/Vec3.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/RT/Vec4.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/RT/Mat22.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/RT/Mat33.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/RT/Mat44.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/RT/Quat.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/RT/Xfo.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/RT/RGBA.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/RT/Color.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/RT/Euler.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/RT/OGLShaderProgram.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/RT/OGLTexture2D.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/RT/OGLTextureCube.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/RT/OGLBuffer.js" charset="utf-8"></script>

    <script type="text/javascript" src="../../../SceneGraph/FABRIC.SceneGraph.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/FABRIC.SceneGraph.Geometry.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/FABRIC.SceneGraph.Primitives.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/FABRIC.SceneGraph.Lights.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/FABRIC.SceneGraph.Materials.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/FABRIC.SceneGraph.Manipulation.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../../SceneGraph/FABRIC.SceneGraph.Kinematics.js" charset="utf-8"></script>
    
<script type="text/javascript">

 var _gaq = _gaq || [];
 _gaq.push(['_setAccount', 'UA-25833362-1']);
 _gaq.push(['_trackPageview']);

 (function() {
   var ga = document.createElement('script'); ga.type =
'text/javascript'; ga.async = true;
   ga.src = ('https:' == document.location.protocol ? 'https://ssl' :
'http://www') + '.google-analytics.com/ga.js';
   var s = document.getElementsByTagName('script')[0];
s.parentNode.insertBefore(ga, s);
 })();

</script>

    <script type="text/javascript">

FABRIC.SceneGraph.registerNodeType('3DTextureGenerator', {
  briefDesc: '',
  detailedDesc: '',
  parentNodeDesc: 'Scene',
  optionsDesc: {
  },
  factoryFn: function(options, scene) {
    scene.assignDefaults(options, {
        resolution: 128
      });

    var generatorNode = scene.constructNode('SceneGraphNode', options);
    var dgnode = generatorNode.constructDGNode('DGNode');

    dgnode.addMember('resolution', 'Size', options.resolution );
    dgnode.addMember('width', 'Size' );
    dgnode.addMember('height', 'Size' );
    dgnode.addMember('depth', 'Size' );
    dgnode.addMember('opacityVoxels', 'Byte[]');
    dgnode.addMember('weightedGradientsVoxels', 'RGBA[]');

    generatorNode.addMemberInterface(dgnode, 'resolution', true);
    generatorNode.addMemberInterface(dgnode, 'width');
    generatorNode.addMemberInterface(dgnode, 'height');
    generatorNode.addMemberInterface(dgnode, 'depth');

    dgnode.bindings.append(scene.constructOperator({
      operatorName: 'generate3DTexture',
      parameterLayout: [
        'self.resolution',
        'self.width',
        'self.height',
        'self.depth',
        'self.opacityVoxels',
        'self.weightedGradientsVoxels'
      ],
      entryFunctionName: 'generate3DTexture',
      srcFile: 'KL/3DTextureUtils.kl'
    }));

    return generatorNode;
  }
});

FABRIC.SceneGraph.registerNodeType('Texture2DSliceDisplay', {
  briefDesc: '',
  detailedDesc: '',
  parentNodeDesc: 'Scene',
  optionsDesc: {
    sourceImageNode: 'The source 3D image node',
    tl: 'Top left screenspace coord',
    br: 'Bottom right screenspace coord',
    sliceRatio: 'Slice ratio (0 to 1) along sliceAxis',
    sliceAxis: 'Slice axis (0=X, 1=Y, 2=Z) along which the image is extracted',
    opacityElseGradientWeight: 'Show opacity, else will be gradient weight'
  },

  factoryFn: function(options, scene) {
    scene.assignDefaults(options, {
        tl: new FABRIC.RT.Vec2(-1.0, 1.0),
        br: new FABRIC.RT.Vec2(1.0, -1.0),
        sliceRatio: 0.5,
        sliceAxis: 0,
        opacityElseGradientWeight: true
      });

    options.wantHDR = false;
    options.createDgNode = true;
    options.createResourceLoadNode = false;
    options.createLoadTextureEventHandler = true;

    var sliceDisplayNode = scene.constructNode('Image', options);
    var dgnode = sliceDisplayNode.getDGNode();

    dgnode.addMember('sliceRatio', 'Scalar', options.sliceRatio );
    dgnode.addMember('sliceAxis', 'Size', options.sliceAxis );
    dgnode.addMember('opacityElseGradientWeight', 'Boolean', options.opacityElseGradientWeight );

    var sourceImageNode = scene.getPrivateInterface(options.sourceImageNode);
    dgnode.setDependency(sourceImageNode.getDGNode(), 'source');

    dgnode.bindings.append(scene.constructOperator({
      operatorName: 'slice3DTexture',
      parameterLayout: [
        'self.sliceRatio',
        'self.sliceAxis',
        'self.opacityElseGradientWeight',
        'source.width',
        'source.height',
        'source.depth',
        'source.opacityVoxels',
        'source.weightedGradientsVoxels',
        'self.width',
        'self.height',
        'self.pixels'
      ],
      entryFunctionName: 'slice3DTexture',
      srcFile: 'KL/3DTextureUtils.kl'
    }));

    var postDrawEventHandler = sliceDisplayNode.constructEventHandlerNode('PostDraw');
    var toto = sliceDisplayNode.getRedrawEventHandler();
    postDrawEventHandler.appendChildEventHandler(sliceDisplayNode.getRedrawEventHandler());//ICI
    scene.getScenePostRedrawEventHandler().appendChildEventHandler(postDrawEventHandler);

    postDrawEventHandler.addMember('tl', 'Vec2', options.tl );
    postDrawEventHandler.addMember('br', 'Vec2', options.br );

    postDrawEventHandler.setScopeName('textureStub');
    postDrawEventHandler.addMember('textureUnit', 'Integer', 0);
    postDrawEventHandler.addMember('program', 'Integer', 0);
    postDrawEventHandler.postDescendBindings.append(
      scene.constructOperator({
          operatorName: 'drawTexture',
          srcFile: 'FABRIC_ROOT/SceneGraph/KL/drawTexture.kl',
          entryFunctionName: 'drawTextureAt',
          parameterLayout: [
            'self.tl',
            'self.br',
            'self.textureUnit',
            'self.program'
          ]
        }
    ));
    return sliceDisplayNode;
  }
});
    
$(document).ready(function() {
  
  var scene = FABRIC.SceneGraph.createScene();
  var viewport = scene.constructNode('Viewport', {
    windowElement: document.getElementById('FabricContainer'),
    backgroundColor: FABRIC.RT.rgb(0.0, 0.05, 0.15)
  });
  
  viewport.setBackgroundTextureImage(scene.constructNode('Image', {
    url: '../BasicDemos/Resources/fabric-demo-gradient.png'
  }));
  
  // Create a camera to draw the scene from
  var camera = scene.constructNode('TargetCamera', {
      position: new FABRIC.RT.Vec3(0, 0, 20),
      target: new FABRIC.RT.Vec3(0, 0, 0),
      screenOffset: new FABRIC.RT.Vec2(-0.25, 0.0)
    });

  scene.constructNode("CameraManipulator", { targetNode:camera } );

  viewport.setCameraNode(camera);

  var light = scene.constructNode('PointLight', { position: new FABRIC.RT.Vec3(420.0, 1000.0, 600.0) });
  var transform =  scene.constructNode('Transform', {
    hierarchical: false,
    globalXfo: new FABRIC.RT.Xfo({ tr: new FABRIC.RT.Vec3(0, 0, 0) })
  });

  var volume = scene.constructNode('VolumeSlices', { nbSlices: 100, cameraNode: camera, transformNode: transform, cropMin: new FABRIC.RT.Vec3(0, 0, 0), cropMax: new FABRIC.RT.Vec3(1, 1, 1) });

  var textureGen = scene.constructNode('3DTextureGenerator');
  var texture2DSlice = [];
  texture2DSlice[0] = scene.constructNode('Texture2DSliceDisplay', {tl: new FABRIC.RT.Vec2(0.5, 1.0), br: new FABRIC.RT.Vec2(1.0, 1.0/3.0), sourceImageNode: textureGen, sliceRatio: 0.5, sliceAxis : 0});
  texture2DSlice[1] = scene.constructNode('Texture2DSliceDisplay', {tl: new FABRIC.RT.Vec2(0.5, 1.0/3.0), br: new FABRIC.RT.Vec2(1.0, -1.0/3.0), sourceImageNode: textureGen, sliceRatio: 0.5, sliceAxis : 1});
  texture2DSlice[2] = scene.constructNode('Texture2DSliceDisplay', {tl: new FABRIC.RT.Vec2(0.5, -1.0/3.0), br: new FABRIC.RT.Vec2(1.0, -1.0), sourceImageNode: textureGen, sliceRatio: 0.5, sliceAxis : 2});

  var flatMaterial = scene.constructNode('FlatMaterial', {
      color: FABRIC.RT.rgb(0.8, 0, 0, 1)
    });

  scene.constructNode('Instance', {
      transformNode:transform,
      geometryNode: volume,
      materialNode: flatMaterial
    });

  $('#loadingDialog').dialog({
    modal: true
  });
  FABRIC.appendOnResolveAsyncTaskCallback(function(label, nbRemaining, doneWeight, totalWeight) {
    $('#loadingProgressBar').progressbar({
      value: (1.0-(doneWeight/totalWeight))*100
    });
    if (nbRemaining===0) {
      $('#loadingDialog').dialog('close');
      var errors = scene.getErrors();
      if (errors.length > 0) {
        throw (errors.toString());
      }
      
      if(!viewport.getGlewSupported('GL_EXT_geometry_shader4')){
        console.log("the shader that is drawping the normals will not display on this machine, because it does not support geometry shaders");
      }
  
      viewport.redraw();
      return true;
    }
  });
  
});

</script>

  </head> 
  <body>
    <div id="loadingDialog" title="Loading...">
      <h4 id="loadingDesc" style="margin-bottom: 10px"></h4>
      <div id="loadingProgressBar" class="ui-progressbar-value"></div>
    </div>
    <div id="wrapper">
      <ul id="nav">
        <li><a href="#" id="fabric-logo"><img src="../../../themes/default/_img/projects/fabric-logo.png" /></a></li>
      </ul>
      <div id="editor">
        <div id="viewer">
          <div id="FabricContainer"></div> 
        </div><!--viewer-->
        <div id="sidebar">
          
          <div class="box">
            <h2>INFO</h2>
            <div class="content">
              Materials.<br>
              This sample shows the creation of several materials through FABRIC's JavaScript based SceneGraph.
              All Materials are implemented using GLSL shaders, from Constant, Phong, Textures, Normal Mapping
              to Geometry Shaders for drawing the normals of the last object. Check out the source code of this
              page to see how this works.
            </div><!--content-->
          </div><!--box-->
            
        </div><!--sidebar-->
      </div> <!--editor-->
    </div><!--wrapper-->
  </body> 
  </html>
