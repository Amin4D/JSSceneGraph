<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd"> 
<html xmlns="http://www.w3.org/1999/xhtml">
  <!--
    Copyright 2010-2011 Fabric Technologies Inc. All rights reserved.
    -->
  <head>
  <meta http-equiv="Content-Language" content="en" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>FABRIC Debugger</title>
    
    <meta charset="iso-8859-1"/>
    <link href="../../themes/default/style.css" rel="stylesheet" type="text/css" />
    <link href="../../themes/default/viewer.css" rel="stylesheet" type="text/css" />
    
    <script type="text/javascript" src="../../ThirdParty/jQuery/jquery-1.4.2.min.js"></script>
    <script type="text/javascript" src="../../ThirdParty/jQuery/jquery-ui-1.8.5.custom.min.js"></script>

    <link type="text/css" href="../../ThirdParty/jQuery/css/vader/jquery-ui-1.8.5.custom.css" rel="stylesheet" />

    <script type="text/javascript" src="../FABRIC.js" charset="utf-8"></script>
    <script type="text/javascript" src="../FABRIC.Wrappers.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../SceneGraph/Resources/RT/Math.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../SceneGraph/Resources/RT/Vec2.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../SceneGraph/Resources/RT/Color.js" charset="utf-8"></script>
    
    <script type="text/javascript" src="../../SceneGraph/Resources/FABRIC.SVG.js"></script>
    
    <style type="text/css">
    
rect.EditorButton {
  fill:#808080;
  stroke:white;
  stroke-opacity:0.85;
  stroke-width:0.5;
}


rect.EventCatcher {
  fill-opacity:0.0;
  stroke-opacity:0.0;
}

circle.EventCatcher {
  fill-opacity:0.0;
  stroke-opacity:0.0;
  stroke-width:0.0;
}


rect.Shadow {
  fill-opacity:0.25;
  stroke-opacity:0;
  stroke-width:0;
}

circle.Shadow {
  fill-opacity:0.25;
  stroke-opacity:0.25;
}

g.Pressed {
  stroke:white;
  stroke-width:2.5;
}


g.Button {
  stroke:black;
  stroke-opacity:0.75;
  stroke-width:0.5;
}


text.ButtonLabel {
  font-family:Helvetica;
  font-size:8pt;
  font-weight:normal;
  text-anchor:middle;
  fill: black;
  fill-opacity:1.0;
  stroke-opacity:0.0;
  cursor:default;
}


/* ===================================================== */
/* Nodes */

rect.Node {
  stroke:black;
  stroke-opacity:0.75;
  stroke-width:0.5;
  fill-opacity:0.75;
}



text.NodeLabel {
  font-family:Helvetica;
  font-size:8pt;
  font-weight:normal;
  fill: black;
  fill-opacity:1.0;
  stroke-opacity:0.0;
  cursor:move;
}



/* ===================================================== */
/* Ports */

text.PortLabel {
  font-family:Helvetica;
  font-size:7pt;
  font-weight:normal;
  fill: black;
  fill-opacity:1.0;
  stroke-opacity:0.0;
  cursor:move;
}


circle.DFGNodePort {
  fill-opacity:0.95;
  stroke-opacity:0.4;
  stroke:black;
  stroke-width:1;
}

circle.Highlighted {
  stroke:white;
  stroke-opacity:0.6;
}



/* ===================================================== */
/* Operators */
rect.Operator {
  stroke:black;
  stroke-opacity:0.75;
  stroke-width:0.5;
  fill-opacity:0.75;
}

/* ===================================================== */
/* Events */

text.EventOperatorLabel {
  font-family:Helvetica;
  font-size:5pt;
  font-weight:normal;
  fill: black;
  fill-opacity:1.0;
  stroke-opacity:0.0;
  cursor:move;
}
rect.EventOperator {
  stroke:black;
  stroke-opacity:0.75;
  stroke-width:0.5;
  fill-opacity:1.0;
}

/* ===================================================== */
/* Connections */


path.LineCore {
  fill: none;
  stroke-opacity:1.0;
  stroke-width:2.5;
}

path.LineBorder {
  fill: none;
  stroke:black;
  stroke-opacity:0.6;
  stroke-width:3.5;
}

path.EventCatcher {
  fill: none;
  stroke:black;
  stroke-opacity:0.0;
  stroke-width:10;
}

path.Highlighted {
  stroke:white;
}



/* ===================================================== */
/* Highlighting */

rect.Highlighted {
  stroke:white;
  stroke-opacity:0.85;
  stroke-width:0.75;
}
g.Highlighted {
  stroke:white;
}

  
  </style>
    <script type="text/javascript">


$(document).ready(function() {
  
  if(!window.context){
    var contextID = document.location.search.split('?id=')[1];
    window.context = FABRIC.createContext({ contextID:contextID  });
  }
  
  var allNamedObjects = context.DG.getAllNamedObjects();
  
  var eventsMap = {};
  var eventHandlersMap = {};
  var nodesMap = {};
  for(var i in allNamedObjects){
    if(!allNamedObjects[ i ].getType){
      continue;
    }
    var type = allNamedObjects[ i ].getType();
    if(type === "Event"){
      eventsMap[i] = allNamedObjects[ i ];
    }
    else if(type === "EventHandler"){
      eventHandlersMap[i] = allNamedObjects[ i ];
    }
    if(type === "Node"){
      nodesMap[i] = allNamedObjects[ i ];
    }
  }
  
  var ehcolumns = [];
  var dgcolumns = [];
  
  var layoutDGNodes = function(dgnode, column){
    if(!dgcolumns[column]) dgcolumns[column] = [];
    if(dgnode.column){
      if(dgnode.column > column){
        // Re-assign the node to the new column;
        var row = dgcolumns[dgnode.column].indexOf(dgnode);
        dgcolumns[dgnode.column][row] = undefined;
        dgcolumns[column].push(dgnode);
        dgnode.column = column;
      }
    }else{
      dgcolumns[column].push(dgnode);
      dgnode.column = column;
    }
    var dependencies = dgnode.getDependencies();
    for(var i in dependencies){
      layoutDGNodes(dependencies[i], column-1)
    }
  }
  
  var layoutEventHandlers = function(children, column, parentrow){
    if(children.length > 0){
      if(!ehcolumns[column]) ehcolumns[column] = [];
      for(var j=0; j < children.length; j++){
        var eventHandler = children[j];
        var row = 0;
        if(eventHandler.column ){
          if( eventHandler.column < column){
            // Re-assign the handler to the new column;
            row = ehcolumns[eventHandler.column].indexOf(eventHandler);
            ehcolumns[eventHandler.column][row] = undefined;
            row = ehcolumns[column].length;
            ehcolumns[column].push(eventHandler);
            eventHandler.column = column;
          }
        }else{
          row = ehcolumns[column].length;
          // ensure that in the event tree, child 
          // nodes are inline with parent nodes. 
          if(row<parentrow) row = parentrow;
          ehcolumns[column][row] = eventHandler;
          eventHandler.column = column;
        }
        layoutEventHandlers(eventHandler.getChildEventHandlers(), column+1, row);
        var scopes = eventHandler.getScopes();
        for(var i in scopes){
          layoutDGNodes(scopes[i], column-1)
        }
      }
    }
  }
  
  ehcolumns[0] = [];
  for(var i in eventsMap){
    var row = ehcolumns[1] ? ehcolumns[1].length : ehcolumns[0].length;
    ehcolumns[0][row] = eventsMap[i];
    layoutEventHandlers(eventsMap[i].getEventHandlers(), 1, row);
  }

  var windowWidth = $('#viewer').width();
  var windowHeight = $('#viewer').height();

  svgRoot = FABRIC.createSVGRootElem('viewer');

  var graphBGRect = svgRoot.createRect().size(windowWidth, windowHeight).addClass('EventCatcher');
  var graphHolderGroup = svgRoot.createGroup().translate(windowWidth * 0.5, windowHeight * 0.5);
  var graphSclGroup = graphHolderGroup.createGroup().scale(1.0);
  var graphPosGroup = graphSclGroup.createGroup().translate(windowWidth * -0.5, 0);
  var curvesHolderGroup = graphPosGroup.createGroup();
  var nodesHolderGroup = graphPosGroup.createGroup();
  
  svgRoot.setGraphHolderGroup(graphPosGroup);
  svgRoot.setNodeHolderGroup(nodesHolderGroup);
  svgRoot.setEdgeHolderGroup(curvesHolderGroup);
  
  svgRoot.draggable({mouseButton:1, delegateTranslateObj:graphPosGroup, highlight:false })
    .zoomable({delegateZoomObj:graphSclGroup })
    .addOnZoomCallback(
      function(evt){
    });
  
  $(window).resize(function () {
    windowWidth = $('#viewer').width();
    windowHeight = $('#viewer').height();
    graphBGRect.size(windowWidth, windowHeight);
  });
  
  var displayOperatorList = function(node, operators){
    for(var i=0; i<operators.getLength(); i++){
      node.addOperator({
          text: operators.getOperator(i).getName(),
          color: FABRIC.RT.rgb255(80,200,200)
        });
    }
  }
  
  var displayEvent = function(name, pos){
    var node = nodesHolderGroup.createNode({
        text : name,
        color:FABRIC.RT.rgb255(90,90,200),
        height: 15,
        createEditButton: true,
        draggable: true,
        shadow: FABRIC.RT.vec2(0,0)
      })
      .translate(pos);
    node.addOutPort({
        color: FABRIC.RT.rgb255(200,80,80),
        allowMultipleConnections:true,
        createLabelEventCatcher:false
      });
    return node;
  }
  
  
  var displayEventHandler = function(name, pos){
    var eventHandler = eventHandlersMap[name];
    var node = nodesHolderGroup.createNode({
        text : name,
        color:FABRIC.RT.rgb255(90,200,90),
        height: 15,
        createEditButton: true,
        draggable: true,
        shadow: FABRIC.RT.vec2(0,0)
      })
      .translate(pos);
    node.addInPort({
        color: FABRIC.RT.rgb255(200,80,80),
        allowMultipleConnections:true,
        createLabelEventCatcher:false
      });
    node.addOutPort({
        color: FABRIC.RT.rgb255(200,80,80),
        allowMultipleConnections:true,
        createLabelEventCatcher:false
      });
    var scopes = eventHandler.getScopes();
    for(var i in scopes){
      node.addInPort({
          text: i,
          color: FABRIC.RT.rgb255(200,200,80),
          allowMultipleConnections:false,
          createLabelEventCatcher:false
        });
    }
    displayOperatorList(node, eventHandler.preDescendBindings);
    displayOperatorList(node, eventHandler.postDescendBindings);
    return node;
  }
  
  
  var displayDGnode = function(name, pos){
    var dgnode = nodesMap[name];
    var node = nodesHolderGroup.createNode({
        text : name,
        color:FABRIC.RT.rgb255(20,90,250),
        height: 15,
        createEditButton: false,
        draggable: true,
        shadow: FABRIC.RT.vec2(0,0)
      })
      .translate(pos);
      
    var dependencies = dgnode.getDependencies();
    for(var i in dependencies){
      node.addInPort({
          text: i,
           color: FABRIC.RT.rgb255(100,180,250),
          allowMultipleConnections:false,
          createLabelEventCatcher:false
        });
    }
    node.addOutPort({
        color: FABRIC.RT.rgb255(200,200,80),
        allowMultipleConnections:true,
        createLabelEventCatcher:false
      });
    node.addOutPort({
        color: FABRIC.RT.rgb255(100,180,250),
        allowMultipleConnections:true,
        createLabelEventCatcher:false
      });
    displayOperatorList(node, dgnode.bindings);
    return node;
  }
  
  var maxrow = 0;
  for(var i=0; i < ehcolumns.length; i++){
    for(var j=0; j < ehcolumns[i].length; j++){
      var dgnode = ehcolumns[i][j];
      if(!ehcolumns[i][j]) continue;
      var column = i;
      var row = j;
      if(i==0){
        dgnode.debuggerNode = displayEvent(dgnode.getName(), FABRIC.RT.vec2(0, row*100));
      }else{
        dgnode.debuggerNode = displayEventHandler(dgnode.getName(), FABRIC.RT.vec2(column*240, row*100));
      }
      if(j>maxrow) maxrow = j;
    }
  }
  
//  for(var i=0; i < dgcolumns.length; i++){
  for(i in dgcolumns){
    if(!dgcolumns[i]) continue;
    for(var j=0; j < dgcolumns[i].length; j++){
      var dgnode = dgcolumns[i][j];
      if(!dgcolumns[i][j]) continue;
      var column = i;//dgcolumns.length - i;
      var row = maxrow + 1 + j;//dgcolumns[i].length - j;
      dgnode.debuggerNode = displayDGnode(dgnode.getName(), FABRIC.RT.vec2(column*240, row*100));
    }
  }
  
  for(var i in eventsMap){
    var children = eventsMap[i].getEventHandlers();
    for(var j=0; j<children.length; j++){
      if(children[j].debuggerNode){
        eventsMap[i].debuggerNode.getOutPort(0)
          .connectTo(children[j].debuggerNode.getInPort(0),{
            fireCallbacks: false,
            connectable: false
          });
      }
    }
  }
  for(var i in eventHandlersMap){
    var eventHandler = eventHandlersMap[i];
    if(eventHandlersMap[i].debuggerNode){
      var children = eventHandlersMap[i].getChildEventHandlers();
      for(var j=0; j<children.length; j++){
        if(children[j].debuggerNode){
          eventHandlersMap[i].debuggerNode.getOutPort(0)
            .connectTo(children[j].debuggerNode.getInPort(0),{
              fireCallbacks: false,
              connectable: false
            });
        }
      }
      var scopes = eventHandler.getScopes();
      var scropeId = 0;
      for(var i in scopes){
        scopes[i].debuggerNode.getOutPort(0)
          .connectTo(eventHandler.debuggerNode.getInPort(scropeId+1),{
            fireCallbacks: false,
            connectable: false
          });
        scropeId++;
      }
    }
  }
  
  for(var i in nodesMap){
    if(nodesMap[i].debuggerNode){
      var dgnode = nodesMap[i];
      var dependencies = dgnode.getDependencies();
      var dependencyId = 0;
      for(var i in dependencies){
        dependencies[i].debuggerNode.getOutPort(1)
          .connectTo(dgnode.debuggerNode.getInPort(dependencyId),{
            fireCallbacks: false,
            connectable: false
          });
        dependencyId++;
      }
    }
  }
  
  $('#displayEventHandlers').button()
      .click(function() {
      });
  $('#displayDependencyGraph').button()
      .click(function() {
      });
});



    </script>



  </head> 
  <body>
    <div id="wrapper">
      <ul id="nav">
        <li><a href="#" id="fabric-logo"><img src="../../themes/default/_img/projects/fabric-logo.png" /></a></li>
      </ul>
      <div id="editor">
        
        <div id="viewer">
        </div><!--viewer-->
        
        <div id="sidebar">
          <div class="box">
            <h2>OPTIONS</h2>
            <div class="content" id="keyframeTracks">
              <input type="checkbox" id="displayEventHandlers" /><label for="displayEventHandlers">Display Event Handlers</label>
              <input type="checkbox" id="displayDependencyGraph"/><label for="displayDependencyGraph" style="margin-top:10px;" >Display Dependency Graph</label>
            </div><!--content-->
          </div><!--box-->
        </div><!--sidebar-->
        
      </div> <!--editor-->
    </div><!--wrapper-->
  </body> 
</html>
